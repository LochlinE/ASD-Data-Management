---
title: "Leaf Data 2022"
author: "Lochlin Ermatinger"
date: "2022-10-08"
output: html_document
---

library packages
```{r}
library(tidyverse)
library(readxl)
library(prospectr)
```

Read in infestation data
```{r}
# Read in infestation data
infestationData <- read_excel("C:\\Users\\lochl\\OneDrive\\Desktop\\Sawfly Lab\\ASD\\2022\\Leaf\\LeafInfestationData2022.xlsx")

#Define location of reflectance files
reflectanceFileStorage <- "C:\\Users\\lochl\\OneDrive\\Desktop\\Sawfly Lab\\ASD\\2022\\Leaf\\allASD\\"
fileNames <- list.files(reflectanceFileStorage)
```

Splice Reflectance Data
```{r}
readRaw <- function(name, location) {
  x = read.delim(paste0(location, name))
  names(x)[2] <- "Reflectance"
  x <- mutate(x, fileName = name)
  return(x)
}

testFiles <- lapply(fileNames, readRaw, location = reflectanceFileStorage)
names(testFiles) <- c(1:length(testFiles))

splicer <- function(x){
  x <- mutate(x, splicedReflectance = spliceCorrection(X = x$Reflectance,
                                            wav = x$Wavelength,
                                            splice = c(965,1775),
                                            interpol.bands = 10))
}

testDataSpliced <- lapply(testFiles,splicer)
```

Create Vectors to translate "tx" to days after infestation
```{r}

Adates <- c(t0 = as.Date('2022-4-12'),t1 = as.Date('2022-4-19'),t2 = as.Date('2022-5-3'),t3 = as.Date('2022-5-10'),t4 = as.Date('2022-5-17'),t5 = as.Date('2022-5-24'))
Bdates <- c(t0 = as.Date('2022-4-27'),t1 = as.Date('2022-5-5'),t2 = as.Date('2022-5-11'),t3 = as.Date('2022-5-18'),t4 = as.Date('2022-5-25'),t5 = as.Date('2022-6-1'))
Cdates <- c(t0 = as.Date('2022-5-3'),t1 = as.Date('2022-5-11'),t2 = as.Date('2022-5-17'),t3 = as.Date('2022-5-24'),t4 = as.Date('2022-5-31'),t5 = as.Date('2022-6-6'),t6 = as.Date('2022-6-13'))
Ddates <- c(t0 = as.Date('2022-5-9'),t1 = as.Date('2022-5-19'),t2 = as.Date('2022-5-23'),t3 = as.Date('2022-5-30'),t4 = as.Date('2022-6-6'),t5 = as.Date('2022-6-13'))
Edates <- c(t0 = as.Date('2022-5-31'),t1 = as.Date('2022-6-9'),t2 = as.Date('2022-6-16'),t3 = as.Date('2022-6-23'),t4 = as.Date('2022-7-15'),t5 = as.Date('2022-7-21'),t6 = as.Date('2022-7-28'))
Fdates <- c(t0 = as.Date('2022-6-10'),t1 = as.Date('2022-6-17'),t2 = as.Date('2022-6-29'),t3 = as.Date('2022-7-15'),t4 = as.Date('2022-7-22'),t5 = as.Date('2022-7-28'))

JAdays <- format(Adates, "%j") 
JBdays <- format(Bdates, "%j")
JCdays <- format(Cdates, "%j")
JDdays <- format(Ddates, "%j")
JEdays <- format(Edates, "%j")
JFdays <- format(Fdates, "%j")

Adays <- c(0,7,22,29,36,43)
Bdays <- c(0,8,14,21,28,36)
Cdays <- c(0,8,14,21,28,34,41)
Cdays6 <- c(0,8,14,21,28,34)
Ddays <- c(0,10,14,21,27,34)
Edays <- c(0,9,16,23,46,52,59)
Edays6 <- c(0,9,16,23,46,52)
Fdays <- c(0,7,12,28,35,41)

Daynames <-c("Adays","Bdays","Cdays","Ddays","Edays","Fdays")
t <- paste(rep("t",6),seq(0,5), sep = "")

DayMat <- tibble(Adays,Bdays,Cdays6,Ddays,Edays6,Fdays) %>% 
  t() %>% 
  data.frame %>% 
  rename_with (~ t)

medianT <- lapply(DayMat,median)
medianT <- sapply(medianT, round)
names(medianT)=="t0"
```



```{r}

fileNameSample <- 
  gsub("[[:digit:]]{5}[.].*", "", fileNames) # Saves everything left of 5 digits from .asd

rm(samplesTable)
sampleNames <- unique(fileNameSample) %>%# creates a vector with unique file names
  gsub(pattern = "[[:space:]]", replacement = "") # This line looks for a space and removes it

samplesTable <-
  tibble(sampleIdx = 1:length(unique(sampleNames)), sampleName = sampleNames)# creates a table with only unique file names sampleIdx is arbitrary

samplesTable <- 
  mutate(samplesTable, time = substr(samplesTable$sampleName,1,2)) %>%
  mutate(samplesTable, replicateType = substr(samplesTable$sampleName,3,3)) %>% 
  mutate(samplesTable, rep = substr(samplesTable$sampleName,4,4)) %>% 
  mutate(samplesTable, treatment = substr(samplesTable$sampleName,5,5)) %>%
  mutate(samplesTable, plantName = substr(samplesTable$sampleName,4,6)) %>%
  mutate(samplesTable, sample = substr(samplesTable$sampleName,6,6))

filesTable <-
  tibble(fileIdx = 1:length(fileNames), fileName = fileNames, sampleName = fileNameSample) %>%
 inner_join(samplesTable) # Join 'SamplesTable' to 'filesTable' using "sampleName" CARDINALITY = M:1

```


```{r NMDS  All Wavelengths }

#Compare Cut to  no Infestation
infestationData %>% drop_na() %>%
filter(infestationDegree %in% c("none","significant"))
  
selectedSamples <- infestationData$plantName[which(infestationData$infestationDegree %in% c("none","significant"))] %>% na.omit()

 
reps <- c("A","B","C")
timeVar <- "t5"


test <- testDataSpliced %>% 
  bind_rows() %>% 
  inner_join(filesTable) %>%
  filter(plantName %in% selectedSamples) %>% # filter for groups (i.e. cut | infestationDegree | threeInfestedNodes)
  group_by(sampleName,Wavelength) %>%
  summarize(spliceRef = mean(splicedReflectance)) %>%
  inner_join(samplesTable) %>%
  #filter(rep %in% reps) %>%
  filter(time == timeVar) %>%
  group_by(plantName) %>%
  select(c(Wavelength,plantName,spliceRef)) %>%
  pivot_wider(names_from = plantName, values_from = spliceRef) %>% t() %>%
  as.data.frame() %>%
  rename_with(~ c(350:2500)) %>%
  slice(-1)

test_NMDS = metaMDS(test,k=2, try = 1000)

nmds_scores_test <- test_NMDS %>% 
  scores()

# joining NMDS data to attribute data
## Filter samples table to match time of this run.

samplesTable %>% left_join(infestationData, by = c("plantName"))

samplesTableNMDS <- samplesTable %>% 
  left_join(infestationData, by = c("plantName")) 
  #filter(time == timeVar) 
  #filter(infestationDegree %in% c("none","significant"))

test_NMDS_results <- nmds_scores_test %>%
  as.data.frame() %>%
  rownames_to_column("plantName") %>%
  left_join(samplesTableNMDS, by = "plantName")

# creating a mean for each endohpyte group
test_NMDS_centroids <- test_NMDS_results %>%
  group_by(cut) %>%
  summarize(NMDS1 = mean(NMDS1), NMDS2 = mean(NMDS2))

# plotting the NMDS results with the centroid built in
ggplot(test_NMDS_results, aes(NMDS1, NMDS2, col = cut, fill = cut)) +
  stat_ellipse(geom = 'polygon', col = "black", alpha = 0.5) +
  geom_point(shape = 21, col = "black") +
  geom_point(data = test_NMDS_centroids, size = 5, shape = 21, color = "black", 
             aes(fill = cut), show.legend = FALSE) + theme_bw()

```


  
  
  group_by(sampleName,Wavelength) %>% # group by sampleName and Wavelength so we can average the two files
  summarize(reflectance = mean(Reflectance)) %>% 
  inner_join(samplesTable) %>%
  select(plantName,sampleName,time, Wavelength,reflectance) %>%
  inner_join(infestationData)


ndviCalc = function( data ){ # Normalized Difference Vegetation Index
  red = data$reflectance[data$Wavelength == 655]
  nir = data$reflectance[data$Wavelength == 865]
  output <- ((nir - red)/(nir + red))
  return(output)
}

lwiCalc = function( data ){ # Leaf Water Index
  R1300 = data$reflectance[data$Wavelength == 1300]
  R1450 = data$reflectance[data$Wavelength == 1450]
  output <- R1300 - R1450
  return(output)
}

priCalc = function( data ){ # Photochemical Reflectance Index
  R531 = data$reflectance[data$Wavelength == 531]
  R570 = data$reflectance[data$Wavelength == 570]
  output <- (R531 - R570)/(R531 + R570)
  return(output)
}

reipCalc <- function( data ) { # Red Edge Inflection Point
  r670 <- data$reflectance[data$Wavelength == 670]
  r700 <- data$reflectance[data$Wavelength == 700]
  r740 <- data$reflectance[data$Wavelength == 740]
  r780 <- data$reflectance[data$Wavelength == 780]
  absorptionMin <- 700
  sig <- 40
  reip <- (absorptionMin+sig*(((r670+r780)/2) - r700)/(r740-r700))
  return(reip)
}

ndmiCalc <- function( data ){ # Normalized Difference Moisture Index
  R860 = data$reflectance[data$Wavelength == 860]
  R1240 = data$reflectance[data$Wavelength == 1240]
  output <- (R860 - R1240)/(R860 + R1240)
  return(output)
}

vegetationIndicesTable <-
  tibble(sampleName = unique(repRef$sampleName),
         plantName = substr(sampleName,5,8),
         time = substr(sampleName,1,2),
         ndviValue = ndviCalc(repRef),
         lwiValue = lwiCalc(repRef),
         priValue = priCalc(repRef),
         reipValue = reipCalc(repRef),
         ndmiValue = ndmiCalc(repRef))
